<!doctype html>
<html>

<head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <link rel="stylesheet" href="../assets/common.css">

   <title>STAR Software Library: Switching from 32- to 64-bit Builds</title>
</head>

<body>

<div class="reveal">
<div class="slides">



<section>

<h1 class="title">STAR Software Library:<br>32-bit vs 64-bit Builds</h1>

<h2 class="title">Memory Usage by Reconstruction Chain</h2>

<h3 class="title">Dmitri Smirnov</h3>

<h5 class="title">
Updated <script>document.write((new Date(document.lastModified)).toLocaleDateString("en-US", {year: 'numeric', month: 'long', day: 'numeric'}))</script>
</h5>

</section>



<section data-markdown> <textarea data-template> <h1>Introduction and Motivation</h1>

- This study is motivated by increase in memory usage for 64-bit builds as reported by nightly tests

  - Expectated increase due to change in data model from **ILP32** to **LP64** on Unix-like systems
    - **ILP32** or **4/4/4**: int, long, and pointer are 32-bit
    - **LP64** or **4/8/8**: int is 32-bit, long and pointer are 64-bit

- Observe increase about 50% in the total virtual memory for the same reconstruction chain

- It is not clear whether this increase causes any inefficiency in running event reconstruction on multicore machines

  - Nevertheless, it is worth checking and have it under control if possible

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>STAR Library Sizes</h1>

- Investigate predefined build types in CMake

  - `CMAKE_BUILD_TYPE=Release` (i.e. `-O2 -DNDEBUG`)
  - `CMAKE_BUILD_TYPE=RelWithDebInfo` (i.e. `-O2 -g -DNDEBUG`)
  - `CMAKE_BUILD_TYPE=MinSizeRel` (i.e. `-Os -DNDEBUG`)

- First, compare library sizes for 32- and 64-bit builds

<img class="hcenter" src="graphics/memory_lib_file_sizes.svg" width="55%" />

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>STAR Library Sizes: Top 20</h1>

<img class="hcenter" src="graphics/memory_lib_file_sizes_top20.svg" width="70%" />

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>Memory Usage Dignostics</h1>

- We monitor changes in memory used by reconstruction chains. This is done by means of
  1. Calls to `stlib`'s `mallinfo()` to obtain allocated memory in the heap
  2. Queries to `/proc/<PID>/status` to obtain the total virtual memory used by the
  process

<span style="font-size: 80%">

- Use diagnostics provided by `StarRoot/StMemStat`
- Specific to STAR soft: Set environment variable `StarEndMakerShell`

</span>


</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>StMemStat</h1>

<img class="hcenter" src="graphics/memory_calls_overall.svg" width="80%" />

- We run a test job reconstructing three events
- `-Os` compiler flag only marginally reduces the memory footprint 

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>StMemStat: 64 vs 32 Difference</h1>
<img class="hcenter" src="graphics/memory_calls_diff.svg" width="80%" />

- Observe difference before first measurement. ROOT + other dependencies (e.g. cxx4log, ...) + few STAR libraries?
- Mapped libraries maybe responsible for upto 70% of overall difference

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>StMemStat: Constructors</h1>
<img class="hcenter" src="graphics/memory_calls_constructor.svg" width="65%" />

- Ignore the last two points as those calls are made directly rather than by the framework

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>StMemStat: Loads</h1>
<img class="hcenter" src="graphics/memory_calls_load.svg" width="65%" />

- Weak dependence on library size?
- RTS has not been looked at in details

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>StMemStat: Init</h1>
<img class="hcenter" src="graphics/memory_calls_init.svg" width="65%" />
</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>Statistical Analysis of ELF Files</h1>

<div style="width: 70%; float:left">
<img src="graphics/memory_select_elf_size.svg" width="100%" />
</div>

<div style="width: 30%; float:right">

- It is noted that a significant fraction of symbols (both objects and functions) is generated by `rootcint`
- We disabled `rootcint` processing for `Sti` libraries
- The library file size does increase significantly

</div>

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>Statistical Analysis of ELF Files</h1>

<div style="width: 70%; float:left">
<img src="graphics/memory_select_elf_frac_rs.svg" />
</div>

<div style="width: 30%; float:right">

- It is noted that a significant fraction of symbols (both objects and functions) is generated by `rootcint`
- We disabled `rootcint` processing for `Sti` libraries

</div>

</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>StMemStat: Loads with No Dictionaries (Sti)</h1>

<img class="hcenter" src="graphics/memory_calls_load_rel_dic.svg" width="70%" />

- Effect on the memmory mapped part appears to be marginal
</textarea>
</section>



<section data-markdown> <textarea data-template> <h1>Summary</h1>

- Investigates primary sources causing increase in the total memory

- Recommendations

  - While does not seem to reduce the memory footprint it may still be beneficial to avoid ROOT dictionary generation by `rootcint` where unnecessary

  - Do not load unused libraries such as `Stv`, `Sst`, `Svt`, ...

- It is still not clear if the observed increase in the total memory can cause any inefficiency in reconstruction jobs
  - We look at the total virtual memory, the residual memory can be significantly smaller

</textarea>
</section>



</div>
</div>

<script src="../assets/reveal.js/js/reveal.js"></script>

<script>
Reveal.initialize({
   // XGA (1024 x 768, AR = 1.334), WXGA (1280 x 800, AR = 1.6), HD (1920 x 1080, AR = 1.778)
   // AR = 1.6
   width: 1120, height: 700,
   math: {
      mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
      config: 'TeX-AMS_SVG-full'
   },
   dependencies: [
      { src: '../assets/reveal.js/plugin/markdown/marked.js' },
      { src: '../assets/reveal.js/plugin/markdown/markdown.js' },
      { src: '../assets/reveal.js/plugin/notes/notes.js', async: true },
      { src: '../assets/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: '../assets/reveal.js/plugin/math/math.js', async: true }
   ],
   controls: false,
   history: true,
   center: false,
   progress: false,
   transition: 'none',
   transitionSpeed: 'fast',
   viewDistance: 100
});

Reveal.configure( { slideNumber: 'c', hashOneBasedIndex: true, showSlideNumber: 'all' } );
</script>

</body>
</html>
